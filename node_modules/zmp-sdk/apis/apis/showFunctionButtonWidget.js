import t from'./../external/@swc/helpers/src/_async_to_generator.mjs.js';import e from'./../external/@swc/helpers/src/_object_without_properties.mjs.js';import o from'./../external/@swc/helpers/src/_sliced_to_array.mjs.js';import n from'./../external/@swc/helpers/src/_to_consumable_array.mjs.js';import r from'./../external/zod/lib/index.mjs.js';import i from"../appEnv/index.js";import s from"../common/notFound.js";import{functionHandler as a}from"../utils/decorator.js";import c from"../common/token.js";import{getAccessToken as l}from"./getAccessToken.js";import{WIDGET_URLS as d,ALLOW_WIDGET_ORIGIN as u}from"../constants.js";import{__generator as m}from'./../external/tslib/tslib.es6.js';var p,f=[r.object({id:r.string(),type:r.string(),text:r.string(),color:r.string().optional(),disabled:r.boolean().optional(),onDataReceived:r.function().optional(),onError:r.function().optional()}).catchall(r.any())];function y(t){return h.apply(this,arguments)}function h(){return h=t((function(r){return m(this,(function(y){return[2,a("showFunctionButtonWidget",f,[r],(h=t((function(r){var a,f,y,h,v,j,g;return m(this,(function(w){if(i.isMp){try{a=document.getElementById(r.id),f=r.onDataReceived,y=r.onError,h=e(r,["onDataReceived","onError"]),a&&(v=document.createElement("iframe"),j="ifFBW-".concat(r.id,"-").concat(Date.now()),(g=new URL(d.FUNCTION_BUTTON)).searchParams.set("id",j),g.searchParams.set("appId",window.APP_ID),Object.entries(h).forEach((function(t){var e=o(t,2),n=e[0],r=e[1];r&&g.searchParams.set("data-".concat(n),String(r))})),v.id=j,v.src=g.href,v.style.width="100%",v.style.height="100%",v.style.border="none",Object.entries(h).forEach((function(t){var e=o(t,2),n=e[0],r=e[1];r&&v.setAttribute("data-".concat(n),String(r))})),a.innerHTML=v.outerHTML,window.removeEventListener("message",p,!1),p=function(){var e=t((function(t){var e,o,r,i,s,a,d,p,v,w,_,b,E;return m(this,(function(m){switch(m.label){case 0:return e=t.data,t.origin.startsWith(u)?(o=document.getElementById(j),r=e.type,(i=new URL(e.href)).origin!==g.origin||i.pathname!==g.pathname||e.id!==j?[3,4]:"buttonClicked"!==r?[3,3]:[4,c.jumpAndGetToken()]):[3,4];case 1:return m.sent(),p=null===(s=c.miniProgramConfig)||void 0===s?void 0:s.jwt,v=null===(a=c.miniProgramConfig)||void 0===a?void 0:a.encryptKey,[4,l()];case 2:return w=m.sent(),null==o||null===(d=o.contentWindow)||void 0===d||d.postMessage({type:r,payload:{jwt:p,encryptKey:v,accessToken:w}},u),[3,4];case 3:"onSuccess"===r?(null==(_=e.payload)?void 0:_.type)===h.type&&(b={callAction:function(t,e){var n;null==o||null===(n=o.contentWindow)||void 0===n||n.postMessage({type:"context.callAction",payload:{actionName:t,actionData:e}},u)}},null==f||f.apply(void 0,n(Object.values(_)).concat([b]))):"onError"===r&&(null==(E=e.payload)?void 0:E.type)===h.type&&(null==y||y(null==E?void 0:E.data)),m.label=4;case 4:return[2]}}))}));return function(t){return e.apply(this,arguments)}}(),window.addEventListener("message",p,!1))}catch(t){console.log(t)}return[2,Promise.resolve()]}return i.isMpWeb?[2,Promise.resolve()]:[2,Promise.reject(s("showFunctionButtonWidget",{}))]}))})),function(t){return h.apply(this,arguments)}))];var h}))})),h.apply(this,arguments)}export{y as showFunctionButtonWidget};
