import r from'./../../external/@swc/helpers/src/_async_to_generator.mjs.js';import e from'./../../external/@swc/helpers/src/_instanceof.mjs.js';import o from'./../../external/@swc/helpers/src/_object_spread.mjs.js';import t from'./../../external/@swc/helpers/src/_object_without_properties.mjs.js';import n,{object as s}from'./../../external/zod/lib/index.mjs.js';import i from"../../appEnv/index.js";import a from"../../common/notFound.js";import{functionHandler as m}from"../../utils/decorator.js";import{CHECKOUT_KIT_WIDGET_ID as u,WIDGET_URLS as c,ALLOW_WIDGET_ORIGIN as p}from"../../constants.js";import{postMessageToWidget as d}from"../../utils/common.js";import{__generator as l}from'./../../external/tslib/tslib.es6.js';var f,h=[s({amount:n.union([n.string(),n.number()]),desc:n.string(),payload:n.object({}).catchall(n.any()).optional()}).catchall(n.any())];function j(r){return _.apply(this,arguments)}function _(){return _=r((function(n){return l(this,(function(s){return[2,m("purchase",h,[n],(j=r((function(n){return l(this,(function(s){return i.isMp?[2,new Promise((function(s,i){var m=document.getElementById(u),h=new URL(c.CHECKOUT_KIT);if(!(m&&e(m,HTMLIFrameElement)&&m.src.startsWith(h.origin)&&m.src.includes(h.pathname)))return i(a("purchase",{message:"Widget not found or not initialized."}));var j=t(n,["amount","desc","payload"]),_="purchase";d(m,_,o({amount:String(n.amount),desc:n.desc,payload:n.payload||{}},j)),window.removeEventListener("message",f,!1),f=function(){var e=r((function(r){var e,o,t;return l(this,(function(n){if(e=r.data,r.origin.startsWith(p)&&(o=e.type,(t=new URL(e.href)).origin===h.origin&&t.pathname===h.pathname&&e.id===u)){if(o===_)return[2,s(e.payload)];if("onError"===o)return[2,i(e.payload)]}return[2]}))}));return function(r){return e.apply(this,arguments)}}(),window.addEventListener("message",f,!1)}))]:i.isMpWeb?[2,Promise.resolve({orderId:"",messageToken:"",transId:""})]:[2,Promise.reject(a("purchase",{}))]}))})),function(r){return j.apply(this,arguments)}))];var j}))})),_.apply(this,arguments)}export{j as purchase};
