import e from'./../external/@swc/helpers/src/_async_to_generator.mjs.js';import r from'./../external/@swc/helpers/src/_to_consumable_array.mjs.js';import o,{object as s,number as n,array as t,string as a}from'./../external/zod/lib/index.mjs.js';import i from"../appEnv/index.js";import l from"../common/notFound.js";import{functionHandler as u}from"../utils/decorator.js";import c from"../utils/lodash.js";import{APIS as m}from"../constants.js";import d from"../common/apis/general/openProfilePicker.js";import p from"../common/token.js";import{__generator as f,__values as v}from'./../external/tslib/tslib.es6.js';import{OpenProfilePickerType as h}from"../types/enum.js";var _=[s({maxProfile:n().optional().default(1),src:o.enum([h.TOOL_DEL_FRIEND]).optional(),uids:t(a()).optional()}).superRefine((function(e,r){var o=e.src,s=e.maxProfile;o===h.TOOL_DEL_FRIEND?s<1&&r.addIssue({code:"custom",path:["maxProfile"],message:"maxProfile must be at least 1 when src is 'tool_del_friend'"}):(s<1||s>10)&&r.addIssue({code:"custom",path:["maxProfile"],message:"maxProfile must be between 1 and 10"})}))];function b(e){return j.apply(this,arguments)}function j(){return j=e((function(o){return f(this,(function(s){return[2,u("openProfilePicker",_,[o],(n=e((function(e){var o,s,n,t,a,u,h,_,b,j,y,g;return f(this,(function(P){switch(P.label){case 0:return i.isMp?[4,d(null==e?void 0:e.maxProfile,null==e?void 0:e.src,null==e?void 0:e.uids)]:[3,12];case 1:return o=P.sent(),s=function(e,r){return Array.from({length:Math.ceil(e.length/r)},(function(o,s){return e.slice(s*r,s*r+r)}))},o.length>0?[4,p.getAccessToken()]:[3,11];case 2:n=P.sent(),t=s(o,20),a=[],u=!0,h=!1,_=void 0,P.label=3;case 3:P.trys.push([3,8,9,10]),b=function(){var e,o,s,t,i,l,u;return f(this,(function(d){switch(d.label){case 0:e=y.value,d.label=1;case 1:return d.trys.push([1,4,,5]),[4,fetch(m.GET_LIST_USER_INFO,{method:"POST",headers:{"Content-Type":"application/json",access_token:n||""},body:JSON.stringify({fields:"id,name,picture",user_ids:e})})];case 2:return[4,d.sent().json()];case 3:if(0!==(o=d.sent()).error||!o.data)throw new Error(o.message);return t=e.map((function(e){var r,s,n,t,a,i,l,u,m,d,p;return{id:(null===(r=o.data[e])||void 0===r||null===(s=r.user_info)||void 0===s?void 0:s.user_id_by_app)||"",profile:{name:null===(n=o.data[e])||void 0===n||null===(t=n.user_info)||void 0===t?void 0:t.name,avatar:null===(a=o.data[e])||void 0===a||null===(i=a.user_info)||void 0===i||null===(l=i.picture)||void 0===l||null===(u=l.data)||void 0===u?void 0:u.url},code:0!==(null===(m=o.data[e])||void 0===m?void 0:m.error)?-1:0,message:"Get profile: ".concat(c.isUndefined(null===(d=o.data[e])||void 0===d?void 0:d.message)?"Unknown error":null===(p=o.data[e])||void 0===p?void 0:p.message)}})),(s=a).push.apply(s,r(t)),[3,5];case 4:return i=d.sent(),u=e.map((function(e){return{id:e,profile:{name:"",avatar:""},code:-1,message:"Can't get profile: ".concat(i.message)}})),(l=a).push.apply(l,r(u)),[3,5];case 5:return[2]}}))},j=t[Symbol.iterator](),P.label=4;case 4:return(u=(y=j.next()).done)?[3,7]:[5,v(b())];case 5:P.sent(),P.label=6;case 6:return u=!0,[3,4];case 7:return[3,10];case 8:return g=P.sent(),h=!0,_=g,[3,10];case 9:try{u||null==j.return||j.return()}finally{if(h)throw _}return[7];case 10:return[2,{users:a}];case 11:return[2,{users:[]}];case 12:return i.isMpWeb?[2,Promise.resolve({users:[]})]:[2,Promise.reject(l("openProfilePicker",{}))]}}))})),function(e){return n.apply(this,arguments)}))];var n}))})),j.apply(this,arguments)}export{b as openProfilePicker};
