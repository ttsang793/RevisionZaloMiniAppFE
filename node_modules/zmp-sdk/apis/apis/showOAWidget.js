import o from'./../external/@swc/helpers/src/_async_to_generator.mjs.js';import e from'./../external/@swc/helpers/src/_object_without_properties.mjs.js';import t from'./../external/@swc/helpers/src/_sliced_to_array.mjs.js';import n,{object as r,string as i}from'./../external/zod/lib/index.mjs.js';import s from"../appEnv/index.js";import a from"../common/notFound.js";import{functionHandler as c}from"../utils/decorator.js";import l from"../common/token.js";import m from"../common/apis/general/openProfile.js";import{WIDGET_URLS as d,ALLOW_WIDGET_ORIGIN as u}from"../constants.js";import{__generator as p}from'./../external/tslib/tslib.es6.js';var h,f=[r({id:i(),guidingText:i().optional(),color:i().optional(),onStatusChange:n.function().optional(),onError:n.function().optional()}).catchall(n.any())];function g(o){return j.apply(this,arguments)}function j(){return j=o((function(n){return p(this,(function(r){return[2,c("showOAWidget",f,[n],(i=o((function(n){var r,i,c,f,g,j,w,y;return p(this,(function(v){if(s.isMp){try{r=document.getElementById(n.id),i=n.onStatusChange,c=n.guidingText,f=n.color,g=e(n,["onStatusChange","guidingText","color"]),r&&(j=document.createElement("iframe"),w="ifOAW-".concat(n.id,"-").concat(Date.now()),(y=new URL(d.OA)).searchParams.set("id",w),y.searchParams.set("appId",window.APP_ID),c&&y.searchParams.set("guidingText",c),f&&y.searchParams.set("color",f),Object.entries(g).forEach((function(o){var e=t(o,2),n=e[0],r=e[1];r&&y.searchParams.set("data-".concat(n),String(r))})),j.id=w,j.src=y.href,j.style.width="100%",j.style.height="100%",j.style.border="none",r.innerHTML=j.outerHTML,window.removeEventListener("message",h,!1),h=function(){var e=o((function(o){var e,t,n,r,s,a,c,d;return p(this,(function(p){switch(p.label){case 0:return e=o.data,o.origin.startsWith(u)?(t=document.getElementById(w),n=e.type,(r=new URL(e.href)).origin!==y.origin||r.pathname!==y.pathname||e.id!==w?[3,3]:"followOA"!==n&&"getOAInfo"!==n?[3,2]:[4,l.jumpAndGetToken()]):[3,3];case 1:return p.sent(),c=null===(s=l.miniProgramConfig)||void 0===s?void 0:s.jwt,null==t||null===(a=t.contentWindow)||void 0===a||a.postMessage({type:n,payload:{jwt:c}},u),[3,3];case 2:"oaInfo"===n?null==i||i(null===(d=e.payload)||void 0===d?void 0:d.followed):"openOA"===n?m(e.payload.id,"oa"):"heightChange"===n&&(t.style.height="".concat(e.payload,"px")),p.label=3;case 3:return[2]}}))}));return function(o){return e.apply(this,arguments)}}(),window.addEventListener("message",h,!1))}catch(o){console.log(o)}return[2,Promise.resolve()]}return s.isMpWeb?[2,Promise.resolve()]:[2,Promise.reject(a("showOAWidget",{}))]}))})),function(o){return i.apply(this,arguments)}))];var i}))})),j.apply(this,arguments)}export{g as showOAWidget};
