import e from'./../../../../external/@swc/helpers/src/_async_to_generator.mjs.js';import t from'./../../../../external/@swc/helpers/src/_object_spread.mjs.js';import n from'./../../../../external/@swc/helpers/src/_object_spread_props.mjs.js';import o from"../../../token.js";import r from"../../../../utils/query-string.js";import{apiResponse as s}from"../../../../utils/response.js";import{PAYMENT_H5_URL as a,PAYMENT_APIS as i,APP_ID as m}from"../../../../constants.js";import p from"../openWebview.js";import{MPEEmitter as d}from"../../../eventEmitter.js";import c from"./checkTransaction.js";import{getZaloVersionCode as u,isAndroid as l}from"../../../utils.js";import{PaymentConfig as f}from"./utils.js";import{__generator as j}from'./../../../../external/tslib/tslib.es6.js';import{Events as h}from"../../../../types/enum.js";var y,g=(y=e((function(y,g,w,b,I,C,_){var P,v,R,O,S,T,N,k,A,D,E,U,z,J,x,q,B,L,V,W,G;return j(this,(function(F){switch(F.label){case 0:P=m,(v=new URLSearchParams).append("amount",y.toString()),v.append("item",encodeURIComponent(JSON.stringify(g))),v.append("mac",b),w&&v.append("desc",encodeURIComponent(w)),I&&(R=I,"object"==typeof I&&(R=JSON.stringify(I)),v.append("extradata",encodeURIComponent(R))),C&&(O=C,"object"==typeof C&&(O=JSON.stringify(C)),v.append("payload",encodeURIComponent(O))),_&&("string"==typeof _?(v.append("method",_),v.append("isCustom","false")):"object"==typeof _&&(v.append("method",_.id),v.append("isCustom",JSON.stringify(_.isCustom)))),S={headers:{"Content-Type":"application/x-www-form-urlencoded",authorization:"Bearer "}},F.label=1;case 1:return F.trys.push([1,6,,7]),[4,o.jumpAndGetToken()];case 2:return F.sent(),N=null===(T=o.miniProgramConfig)||void 0===T?void 0:T.jwt,S.headers.authorization="Bearer ".concat(N),[4,fetch(i.CREATE_ORDER,n(t({method:"POST"},S),{body:v}))];case 3:return[4,F.sent().json()];case 4:if(!(k=F.sent()).data||0!==k.err)throw s.error.badRequest(k.msg);return A=k.data.id,D=k.data.jwt,E=k.data.messageToken||"",U=window.APP_VERSION,z=window.APP_ENV,J={miniAppId:P,orderId:A},x=k.data.method,q=k.data.isCustom,D&&(J.token=D),U&&(J.version=U),z&&(J.env=z),x&&(J.method=x),q&&(J.isCustom=q),B=r.encode(J),L=new URL("?".concat(B),a).toString(),V=u(),W=l()&&V<742?"normal":"bottomSheet",f.enablePaymentDone=d.getInstance().eventNames().includes(h.PaymentDone),[4,p(L,{style:W}).then((function(){var o=!1;d.getInstance().once(h.WebviewClosed,(function(){setTimeout(e((function(){var e;return j(this,(function(r){switch(r.label){case 0:return o?[3,2]:(d.getInstance().emit(h.PaymentDone,A,{orderId:A}),[4,c({zmpOrderId:A})]);case 1:(e=r.sent()).err>=0&&!e.isCustom&&d.getInstance().emit(h.PaymentClose,e.err,n(t({},e),{zmpOrderId:A})),r.label=2;case 2:return[2]}}))})),500)})),d.getInstance().once(h.OpenApp,(function(){o=!0})),d.getInstance().once(h.PaymentDone,(function(){o=!0,f.enablePaymentDone=!1}))}))];case 5:return F.sent(),[2,{orderId:A,messageToken:E}];case 6:throw G=F.sent(),console.log("Internal error"),G;case 7:return[2]}}))})),function(e,t,n,o,r,s,a){return y.apply(this,arguments)});export{g as default};
