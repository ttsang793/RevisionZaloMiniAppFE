import e from'./../../../../external/@swc/helpers/src/_async_to_generator.mjs.js';import t from'./../../../../external/@swc/helpers/src/_object_spread.mjs.js';import n from'./../../../../external/@swc/helpers/src/_object_spread_props.mjs.js';import o from"../../../token.js";import r from"../../../../utils/query-string.js";import{apiResponse as s}from"../../../../utils/response.js";import{PAYMENT_H5_URL as a,PAYMENT_APIS as i,APP_ID as m}from"../../../../constants.js";import p from"../openWebview.js";import{MPEEmitter as c}from"../../../eventEmitter.js";import d from"./checkTransaction.js";import{getZaloVersionCode as u,isAndroid as l}from"../../../utils.js";import{PaymentConfig as f}from"./utils.js";import{__generator as h}from'./../../../../external/tslib/tslib.es6.js';import{Events as j}from"../../../../types/enum.js";var y,g=(y=e((function(y,g,w,I,b,_,C){var P,R,v,O,S,T,N,k,A,D,E,U,z,J,q,x,B,L,V,W;return h(this,(function(F){switch(F.label){case 0:P=m,(R=new URLSearchParams).append("amount",y.toString()),R.append("item",encodeURIComponent(JSON.stringify(g))),R.append("appId",P),R.append("mac",I),w&&R.append("desc",encodeURIComponent(w)),b&&(v=b,"object"==typeof b&&(v=JSON.stringify(b)),R.append("extradata",encodeURIComponent(v))),_&&(O=_,"object"==typeof _&&(O=JSON.stringify(_)),R.append("payload",encodeURIComponent(O))),C&&("string"==typeof C?(R.append("method",C),R.append("isCustom","false")):"object"==typeof C&&(R.append("method",C.id),R.append("isCustom",JSON.stringify(C.isCustom)))),S={headers:{"Content-Type":"application/x-www-form-urlencoded",authorization:"Bearer "}},F.label=1;case 1:return F.trys.push([1,6,,7]),[4,o.getAccessToken().catch((function(){throw s.error.loginRequired}))];case 2:return T=F.sent(),S.headers.authorization="Bearer ".concat(T),[4,fetch(i.CREATE_ORDER,n(t({method:"POST"},S),{body:R}))];case 3:return[4,F.sent().json()];case 4:if(!(N=F.sent()).data||0!==N.err)throw s.error.badRequest(N.msg);return k=N.data.id,A=N.data.jwt,D=N.data.messageToken||"",E=window.APP_VERSION,U=window.APP_ENV,z={miniAppId:P,orderId:k},J=N.data.method,q=N.data.isCustom,A&&(z.token=A),E&&(z.version=E),U&&(z.env=U),J&&(z.method=J),q&&(z.isCustom=q),x=r.encode(z),B=new URL("?".concat(x),a).toString(),L=u(),V=l()&&L<742?"normal":"bottomSheet",f.enablePaymentDone=c.getInstance().eventNames().includes(j.PaymentDone),[4,p(B,{style:V}).then((function(){var o=!1;c.getInstance().once(j.WebviewClosed,(function(){setTimeout(e((function(){var e;return h(this,(function(r){switch(r.label){case 0:return o?[3,2]:(c.getInstance().emit(j.PaymentDone,k,{orderId:k}),[4,d({zmpOrderId:k})]);case 1:(e=r.sent()).err>=0&&!e.isCustom&&c.getInstance().emit(j.PaymentClose,e.err,n(t({},e),{zmpOrderId:k})),r.label=2;case 2:return[2]}}))})),500)})),c.getInstance().once(j.OpenApp,(function(){o=!0})),c.getInstance().once(j.PaymentDone,(function(){o=!0,f.enablePaymentDone=!1}))}))];case 5:return F.sent(),[2,{orderId:k,messageToken:D}];case 6:throw W=F.sent(),console.log("Internal error"),W;case 7:return[2]}}))})),function(e,t,n,o,r,s,a){return y.apply(this,arguments)});export{g as default};
