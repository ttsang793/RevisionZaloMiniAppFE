import e from'./../../../../external/@swc/helpers/src/_async_to_generator.mjs.js';import r from'./../../../../external/@swc/helpers/src/_object_spread.mjs.js';import o from'./../../../../external/@swc/helpers/src/_object_spread_props.mjs.js';import t from"../../../call/index.js";import n from"../../../token.js";import{IAPPayType as s,ProrationMode as a}from"../../../../types/enum.js";import{apiResponse as d}from"../../../../utils/response.js";import{PAYMENT_APIS as p,APP_ID as i,PRORATION_MODE as m}from"../../../../constants.js";import{__generator as l}from'./../../../../external/tslib/tslib.es6.js';import c from"../../../../appEnv/getEnv.js";var u,f=(u=e((function(e,u,f,_,E,h){var j,I,R,A,v,w,P,T,D,y,C,b,S,g,M;return l(this,(function(l){switch(l.label){case 0:v=i,(w=new URLSearchParams).append("payType",u||s.SUBSCRIPTION),P=a.UNKNOW,f===m.IMMEDIATE_AND_CHARGE_FULL_PRICE&&(P=a.IMMEDIATE_AND_CHARGE_FULL_PRICE),f===m.DEFERRED&&(P=a.DEFERRED),w.append("utm",E||"default"),w.append("merchantTransId",h||""),w.append("prorationMode",P.toString()),w.append("appId",v),_&&w.append("method",_),T="",(null===(j=c())||void 0===j||null===(I=j.platform)||void 0===I?void 0:I.isIOS)?T="ios":(null===(R=c())||void 0===R||null===(A=R.platform)||void 0===A?void 0:A.isAndroid)&&(T="android"),w.append("os",T),w.append("productId",e),D={headers:{"Content-Type":"application/x-www-form-urlencoded",authorization:"Bearer "}},l.label=1;case 1:return l.trys.push([1,5,,6]),[4,n.jumpAndGetToken()];case 2:return l.sent(),C=null===(y=n.miniProgramConfig)||void 0===y?void 0:y.jwt,D.headers.authorization="Bearer ".concat(C),[4,fetch(p.CREATE_IAP_ORDER,o(r({method:"POST"},D),{body:w}))];case 3:return[4,l.sent().json()];case 4:if(!(b=l.sent()).data||!b.data.store||0!==b.err)throw d.error.createIAPOrderFailed(b.err);return S=b.data.store,g=b.data.orderId,[2,new Promise((function(e,o){t("IAP_REQUESTPAYMENT",r({},S),{success:function(){e({orderId:g})},fail:function(e){o(e)}})}))];case 5:throw M=l.sent(),console.log("Internal error"),M;case 6:return[2]}}))})),function(e,r,o,t,n,s){return u.apply(this,arguments)});export{f as default};
