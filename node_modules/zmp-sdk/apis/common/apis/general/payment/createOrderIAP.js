import e from'./../../../../external/@swc/helpers/src/_async_to_generator.mjs.js';import r from'./../../../../external/@swc/helpers/src/_object_spread.mjs.js';import o from'./../../../../external/@swc/helpers/src/_object_spread_props.mjs.js';import t from"../../../call/index.js";import s from"../../../token.js";import{IAPPayType as n,ProrationMode as a}from"../../../../types/enum.js";import{apiResponse as d}from"../../../../utils/response.js";import{PAYMENT_APIS as p,APP_ID as i,PRORATION_MODE as c}from"../../../../constants.js";import{__generator as l}from'./../../../../external/tslib/tslib.es6.js';import m from"../../../../appEnv/getEnv.js";var u,f=(u=e((function(e,u,f,_,E,h){var I,j,R,A,w,T,v,P,D,y,b,C,S,g;return l(this,(function(l){switch(l.label){case 0:w=i,(T=new URLSearchParams).append("payType",u||n.SUBSCRIPTION),v=a.UNKNOW,f===c.IMMEDIATE_AND_CHARGE_FULL_PRICE&&(v=a.IMMEDIATE_AND_CHARGE_FULL_PRICE),f===c.DEFERRED&&(v=a.DEFERRED),T.append("utm",E||"default"),T.append("merchantTransId",h||""),T.append("prorationMode",v.toString()),T.append("appId",w),_&&T.append("method",_),P="",(null===(I=m())||void 0===I||null===(j=I.platform)||void 0===j?void 0:j.isIOS)?P="ios":(null===(R=m())||void 0===R||null===(A=R.platform)||void 0===A?void 0:A.isAndroid)&&(P="android"),T.append("os",P),T.append("productId",e),D={headers:{"Content-Type":"application/x-www-form-urlencoded",authorization:"Bearer "}},l.label=1;case 1:return l.trys.push([1,5,,6]),[4,s.getAccessToken().catch((function(){throw d.error.loginRequired}))];case 2:return y=l.sent(),D.headers.authorization="Bearer ".concat(y),[4,fetch(p.CREATE_IAP_ORDER,o(r({method:"POST"},D),{body:T}))];case 3:return[4,l.sent().json()];case 4:if(!(b=l.sent()).data||!b.data.store||0!==b.err)throw d.error.createIAPOrderFailed(b.err);return C=b.data.store,S=b.data.orderId,[2,new Promise((function(e,o){t("IAP_REQUESTPAYMENT",r({},C),{success:function(){e({orderId:S})},fail:function(e){o(e)}})}))];case 5:throw g=l.sent(),console.log("Internal error"),g;case 6:return[2]}}))})),function(e,r,o,t,s,n){return u.apply(this,arguments)});export{f as default};
