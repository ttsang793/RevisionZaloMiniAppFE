import o from'./../../external/@swc/helpers/src/_async_to_generator.mjs.js';import{RESPONSE_CODE as e,MESSAGES as r}from"../../constants.js";import a from"../../utils/lodash.js";import{MPEEmitter as t,onActionMessage as n,fireActionMessage as l}from"../eventEmitter.js";import{parseJSON as i,getDynamicAPIByAction as s,checkIOSSupportAction as c,serialize as u,convertSDKActionToJumpAction as d,isRequireUserAuthentication as v}from"../../utils/common.js";import m from"../token.js";import{sendLogData as p}from"../utils.js";import f from"../apis/general/getSetting.js";import _ from"../../appEnv/getEnv.js";import{__generator as g}from'./../../external/tslib/tslib.es6.js';import{Events as h}from"../../types/enum.js";var I,b,T,M,j,w,E=(T=_(),M={},j=t.getInstance(),w=[],!1||(n((function(o){var e=o.serialId,r=i(o.result),t=s(null==r?void 0:r.action),n=a.isEmpty(null==r?void 0:r.error_code)?0:null==r?void 0:r.error_code,l=null==r?void 0:r.error_message,c=(null==r?void 0:r.data)||r;if(t&&0===n){var u=JSON.parse(null==r?void 0:r.data);n=a.isEmpty(null==u?void 0:u.error_code)?0:null==u?void 0:u.error_code,l=null==u?void 0:u.error_message,c=(null==u?void 0:u.data)||u}var d={error_code:n,error_message:l,data:c,action:(null==r?void 0:r.action)||o.actionName};if(e&&M[e]){var v=M[e],m=v.callback,p=v.timeout,f=v.isMultiCallback,_=v.options,g=v.downloadListener;!function(o,e){var r=e||{},t=r.success,n=r.fail;0===o.error_code?a.isFunction(t)&&t(o):a.isFunction(n)&&n(o)}(d,m),!f&&delete M[e],p&&clearTimeout(p);var I={action:null==d?void 0:d.action,error:null==d?void 0:d.error_code,message:null==d?void 0:d.error_message,data:{}};try{if("action.open.inapp"===d.action||"action.open.outapp"===d.action){var b=new URL(null==_?void 0:_.url),T="".concat(b.protocol,"//").concat(b.host).concat(b.pathname);I.data={url:T}}if("action.follow.oa"===d.action||"action.unfollow.oa"===d.action){var E=null==_?void 0:_.uid;I.data={uid:E}}if("action.open.chat"===d.action){var N=null==_?void 0:_.uId,S=null==_?void 0:_.type;I.data={uid:N,openChatType:S}}(null==_?void 0:_.onProgress)&&g&&j.off(h.DownloadProgress,g)}catch(o){}w.push(I)}})),j.on(h.AppPaused,(function(){if(w.length>0){var o=w;w=[],p(o)}})),I?clearInterval(I):I=setInterval((function(){if(w.length>0){var o=w;w=[],p(o)}}),5e3),!0),b=o((function(o,t,n,i){var p,_,I,b,w,E,N,S,k,y,O,P,U,C,A,J,L,R,D,Z,F,H,q,x,z,B;return g(this,(function(g){switch(g.label){case 0:return _=Math.floor(1e6*Math.random()),I="".concat(o,"_").concat(_),b=d(o),(null==i?void 0:i.actionName)&&i.actionName.length>0&&(b=null==i?void 0:i.actionName),w=(null==i?void 0:i.isMultiCallback)||!1,E=!1!==(null==i?void 0:i.timeout)&&((null==i?void 0:i.timeout)||!0),N=(null==i?void 0:i.haveCallback)||!1,S=(null==i?void 0:i.skipJump)||!1,k=(null==i?void 0:i.requireAccessToken)||!1,y=v(b),t&&n&&(M[I]={options:t,callback:n,isMultiCallback:w},E&&N&&(M[I].timeout=setTimeout((function(){var a={serialId:I,result:{error_code:e.TIME_OUT,error_message:r.TIME_OUT,data:{timeout:E},action:o}};return l(a),null}),!0===E?8e3:1e3*E))),y?[4,f()]:[3,2];case 1:if(!1===(null==(P=g.sent())||null===(O=P.authSetting)||void 0===O?void 0:O["scope.userInfo"]))return C={serialId:I,result:{error_code:e.UNAUTHORIZED,error_message:r.NEED_USER_AUTH,data:{isMobile:null==T||null===(U=T.platform)||void 0===U?void 0:U.isMobile},action:o}},l(C),[2];g.label=2;case 2:return A=s(b),!(null==T||null===(p=T.platform)||void 0===p?void 0:p.isMobile)||!o||a.isUndefined(ZaloJavaScriptInterface)||T.platform.isIOS&&!c(o)||A&&!1===A.isSupported?(L={serialId:I,result:{error_code:e.CLIENT_NOT_SUPPORT,error_message:r.CLIENT_NOT_SUPPORT,data:{isMobile:null==T||null===(J=T.platform)||void 0===J?void 0:J.isMobile},action:o}},l(L),[2]):(R=u(t),S?[3,4]:[4,m.getJSAccessToken()]);case 3:return Z=g.sent(),[3,5];case 4:Z="",g.label=5;case 5:D=Z,g.label=6;case 6:return g.trys.push([6,10,,11]),S||!k?[3,8]:[4,m.getAccessToken()];case 7:return H=g.sent(),[3,9];case 8:H="",g.label=9;case 9:return F=H,[3,11];case 10:return q=g.sent(),x={serialId:I,result:{error_code:null==q?void 0:q.code,error_message:null==q?void 0:q.message,action:o}},l(x),[2];case 11:try{t&&(null==t?void 0:t.onProgress)&&(z=function(o){!function(o,e){var r=o.progress;e&&e(r)}(o,null==t?void 0:t.onProgress)},M[I].downloadListener=z,j.on(h.DownloadProgress,z))}catch(o){}return B=T.platform.isIOS?window.onNativeMessage(I,b):'window.onNativeMessage("'.concat(I,'", "').concat(b,'")'),[2,ZaloJavaScriptInterface.jsCall(D,b,F,R,B)]}}))})),function(o,e,r,a){return b.apply(this,arguments)});export{E as default};
